---
title: "Figure 5"
author: "Xinyu Yang"
date: "2026-01-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
library(AUCell)
library(clusterProfiler)
library(ggplot2)
library(ggpubr)
library(ggsci)
library(Seurat)
library(magrittr)
library(dplyr)
library(RColorBrewer)

###GSE136206###
pheno <- read.delim('./BRCA_GSE136206_mouse_aPD1aCTLA4_CellMetainfo_table.tsv', 
                    header = TRUE,    # 第一行是列名
                    stringsAsFactors = FALSE)  # 不自动转换字符为因子
test <- Read10X_h5('./BRCA_GSE136206_mouse_aPD1aCTLA4_expression.h5')
WGCNA <- read.gmt("./UPR_WGCNA.gmt") 
##umap图
umap<-pheno[,c(2,3,5)]

cellType <- umap$Celltype..major.lineage. %>% as.data.frame %>%
  `colnames<-` ("Celltype")

colnames(umap)[3]<-'Celltype'
myTheme <- theme(
  panel.background = element_blank(),
  panel.grid = element_blank(),
  axis.line = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  legend.background = element_blank(),
  legend.key = element_blank(),
  legend.key.size = unit(1, "cm"),
  legend.text = element_text(size = 12),
)  
xstart <- min(umap$UMAP_1); xend <- min(umap$UMAP_1) + 3
ystart <- min(umap$UMAP_2); yend <- min(umap$UMAP_2) + 3
cellTypeLoc <- umap %>%
  group_by(Celltype) %>%
  summarise(
    Loc1 = median(UMAP_1),
    Loc2 = median(UMAP_2)
  ) %>% as.data.frame
load('./color_for_scRNAseq.Rdata')
allcolour<-data.color$color.scRNAseq[14:27]
p <- ggplot(umap,aes(x= UMAP_1 , y = UMAP_2 ,colour = Celltype)) +  
  geom_point(size =0.8,alpha=0.5) +  
  scale_colour_manual(values = allcolour)+
  guides(colour = guide_legend(
    override.aes = list(size=3)))+
  geom_segment(aes(x = xstart, y = ystart , xend = xend, yend = ystart),
               colour = "black", linewidth=1,arrow = arrow(length = unit(0.3,"cm")))+ 
  geom_segment(aes(x = xstart, y = ystart, xend = xstart , yend = yend),
               colour = "black", linewidth=1,arrow = arrow(length = unit(0.3,"cm"))) +
  annotate("text", x = xstart +1.5, y = ystart -1, label = "UMAP_1",
           color="black",size = 5, fontface="bold" ) + 
  annotate("text", x = xstart -1, y = ystart + 1.5, label = "UMAP_2",
           color="black",size = 5, fontface="bold" ,angle=90) +
  geom_text(data = cellTypeLoc, 
            mapping = aes(x = Loc1, y = Loc2, label = Celltype),
            color = "black", size = 4.5)+myTheme+
  labs(color='Celltype')+
  theme(legend.title = element_text(size = 15))+
  ggtitle('GSE136206')+theme(plot.title = element_text(size = 18, hjust = 0.5))
p


require("biomaRt")
human <- useMart("ensembl", dataset = "hsapiens_gene_ensembl", host = "https://dec2021.archive.ensembl.org/")
mouse <- useMart("ensembl", dataset = "mmusculus_gene_ensembl", host = "https://dec2021.archive.ensembl.org/")
# save(human,mouse,file = "./biomaRt_ensembl_annotation.Rdata")
genesV2 = getLDS(attributes = c("hgnc_symbol"), filters = "hgnc_symbol",
                 values = rownames(test), mart = human, attributesL = c("mgi_symbol"), martL = mouse, uniqueRows=T)

mouse_genes <- rownames(test)
mapped_genes <- genesV2$HGNC.symbol[match(mouse_genes, genesV2$MGI.symbol)]
mapped_genes[is.na(mapped_genes)] <- mouse_genes[is.na(mapped_genes)]
rownames(test) <- mapped_genes
cells_rankings <- AUCell_buildRankings(test) 
geneSets <- lapply(unique(WGCNA$term), function(x){print(x);WGCNA$gene[WGCNA$term == x]})
names(geneSets) <- unique(WGCNA$term)

#计算AUC得分
cells_AUC <- AUCell_calcAUC(geneSets, cells_rankings,
                            aucMaxRank=nrow(cells_rankings)*0.1)
score <- cells_AUC@assays@data$AUC
pheno$UPR_score <- score[9,]

pheno$Sample[pheno$Sample %in% c("KPB25Luv-7daytreated", "T11-Apobec-7daytreated")] <- "treated"
pheno$Sample[pheno$Sample %in% c("KPB25Luv-Nottreated", "T11-Apobec-Nottreated")] <- "untreated"

malignant_data <- subset(pheno, Celltype..major.lineage. == "Malignant")
ggplot(malignant_data, aes(x = Sample, y = UPR_score)) +
  geom_violin(aes(fill = Sample), alpha = 0.7, trim = TRUE, scale = "area") +
  geom_boxplot(width = 0.15, outlier.shape = NA, alpha = 0.8) +
  stat_compare_means(
    comparisons = list(c("treated", "untreated")),
    method = "t.test",   # 如果你认为近似正态；否则用 "wilcox"
    label = "p.signif"
  ) +
  scale_fill_lancet(
    name = "Group",
    labels = c("untreated" = "Pre", "treated" = "After")
  ) +
  scale_x_discrete(
    limits = c( "untreated","treated"),
    labels = c("Pre", "After")
  ) +
  theme_classic() +
  xlab("") +
  ylab("UPR score") +
  RotatedAxis() +
  scale_y_continuous(
    limits = c(0, 0.3),
    breaks = seq(0, 0.2, by = 0.05),
    expand = c(0, 0)
  ) +
  ggtitle("UPR score before and after immunotherapy")




pheno <- read.delim('./MCC_GSE117988_aPD1aCTLA4_CellMetainfo_table.tsv', 
                            header = TRUE,    # 第一行是列名
                            stringsAsFactors = FALSE)  # 不自动转换字符为因子
test <- Read10X_h5('./MCC_GSE117988_aPD1aCTLA4_expression.h5')

umap<-pheno[,c(2,3,5)]
colnames(umap)[3]<-'Celltype'
head(umap)
myTheme <- theme(
  panel.background = element_blank(),
  panel.grid = element_blank(),
  axis.line = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  legend.background = element_blank(),
  legend.key = element_blank(),
  legend.key.size = unit(1, "cm"),
  legend.text = element_text(size = 12),
)  

xstart <- min(umap$UMAP_1); xend <- min(umap$UMAP_1) + 3
ystart <- min(umap$UMAP_2); yend <- min(umap$UMAP_2) + 3
allcolour<-brewer.pal(6,'Set1')
#allcolour<- colorRampPalette(allcolour)(10)
cellTypeLoc <- umap %>%
  group_by(Celltype) %>%
  summarise(
    Loc1 = median(UMAP_1),
    Loc2 = median(UMAP_2)
  ) %>% as.data.frame

p <- ggplot(umap,aes(x= UMAP_1 , y = UMAP_2 ,colour = Celltype)) +  
  geom_point(size =0.8,alpha=0.5) +  
  scale_colour_manual(values = allcolour)+
  guides(colour = guide_legend(
    override.aes = list(size=3)))+
  geom_segment(aes(x = xstart, y = ystart , xend = xend, yend = ystart),
               colour = "black", linewidth=1,arrow = arrow(length = unit(0.3,"cm")))+ 
  geom_segment(aes(x = xstart, y = ystart, xend = xstart , yend = yend),
               colour = "black", linewidth=1,arrow = arrow(length = unit(0.3,"cm"))) +
  annotate("text", x = xstart +1.5, y = ystart -1, label = "UMAP_1",
           color="black",size = 3, fontface="bold" ) + 
  annotate("text", x = xstart -1, y = ystart + 1.5, label = "UMAP_2",
           color="black",size = 3, fontface="bold" ,angle=90) +
  geom_text(data = cellTypeLoc, 
            mapping = aes(x = Loc1, y = Loc2, label = Celltype),
            color = "black", size = 4.5)+myTheme+
  labs(color='Celltype')
p+labs(title = "GSE117988") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))



##seurat RDS object
cells_rankings <- AUCell_buildRankings(test)  # 关键一步
# ?AUCell_buildRankings

##load gene set, e.g. GSEA lists from BROAD
geneSets <- lapply(unique(WGCNA$term), function(x){print(x);WGCNA$gene[WGCNA$term == x]})
names(geneSets) <- unique(WGCNA$term)
#计算AUC得分
cells_AUC <- AUCell_calcAUC(geneSets, cells_rankings,
                            aucMaxRank=nrow(cells_rankings)*0.1)
score <- cells_AUC@assays@data$AUC
pheno$UPR_score <- score[9,]
pheno_need <- filter(pheno,pheno$Sample%in%c("Tumor_EarlyD27","Tumor_Pre"))

# 只保留恶性细胞
malignant_data <- subset(pheno_need, Celltype..major.lineage. == "Malignant")

# 绘制小提琴图
ggplot(malignant_data, aes(x = Sample, y = UPR_score)) +
  geom_violin(aes(fill = Sample), alpha = 0.7, trim = TRUE, scale = "area") +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  stat_compare_means(comparisons = list(c("Tumor_Pre", "Tumor_EarlyD27")),
                     method = "t.test", label = "p.signif") +
  scale_fill_lancet(
    name = "Group",
    labels = c("Tumor_Pre" = "Pre", "Tumor_EarlyD27" = "After")
  ) +
  scale_x_discrete(limits = c("Tumor_Pre", "Tumor_EarlyD27"),
                   labels = c("Pre", "After")) +
  theme_classic() +
  xlab("") +
  ylab("UPR score") +
  RotatedAxis()+
  ggtitle("UPR score before and after immunoresistence")
```


```{r}
library(clusterProfiler)
library(GSVA)
library(purrr)
library(ComplexHeatmap)
library(circlize)
library(RColorBrewer)
library(cols4all)

test <- readRDS('./exp_all_BRCA.rds')


Co_ihb<-c("BTN3A1",'LAG3',"BTN3A2","PDCD1", "BATF", "ENTPD1", "PRDM1",
          "CTLA4")
Ligan<-c("TGFB1","VEGFB","IL1B","TNFSF9","TNF","IL12A","TNFSF4","IL10",
         "IL4","IL13","IL2","IL1A","IFNA1","IFNG","IFNA2")
Co_stm<-c("TNFRSF14","CD80","TNFRSF4","CD28","ICOS","TNFRSF9","GZMK",
  "CST7","GZMK","GZMA","NKG7")

gene <- c(Co_ihb, Ligan, Co_stm)
cols<- c4a('accent',7)[1:3]#注释块的颜色


row_cols <- setNames(rep(cols, times = c(8, 15, 11)), gene)
row_anno<- rowAnnotation(foo = anno_text(gene,
                                         location= 1,
                                         just= "right",
                                         gp= gpar(fill = row_cols,
                                                  col= "black",
                                                  fontface= 'italic',
                                                  fontsize=15),
                                         width= max_text_width(gene)*1.25))
df<- data.frame(c('GSE12276','GSE1456','GSE58112','GSE9893','TCGA BRCA'))
colnames(df) <- 'Datasets'
col_anno<-HeatmapAnnotation(df = df,
                              show_annotation_name= F,
                              gp= gpar(col = 'white', lwd = 2),
                              col= list(Datasets = c(
                                'GSE12276' = "#FBB4AE",
                                'GSE1456' = "#B3CDE3",
                                'GSE58112' = "#CCEBC5",
                                'GSE9893' = "#DECBE4",
                                'TCGA BRCA' = "#FED9A6"
                              )))

batch_cor <- function(gene = gene, exprSet = exprSet, cor_gene = NULL,method="sp",n.core=2){
  library(future.apply)
  plan("multisession", workers = n.core)
  plan()
  #设置可用的内存
  options(future.globals.maxSize = 10 * 1024^3)
  y <- as.numeric(exprSet[gene,])
  
  if(is.null(cor_gene)){
    cor_gene <-  row.names(exprSet)
    cor_gene <- cor_gene[!cor_gene%in%gene]
  }
  data =  do.call(rbind,future_lapply(cor_gene, function(x){
    dd  <- cor.test(as.numeric(exprSet[x,]),y,method=method)
    data.frame(gene=gene,mRNAs=x,cor=dd$estimate,p.value=dd$p.value )
  }))
  data$FDR = p.adjust(data$p.value,method = "BH")
  return(data)
}

cor_heatmap<-function(r,p,w,h){
  Heatmap(
    as.matrix(r), 
    name = " ", 
    border = "white",
    col = colorRamp2(c(-0.5, 0, 0.5), c( "#0da9ce", "white", "#e74a32")),
    rect_gp = gpar(col = "white", lwd = 2),
    row_order = rownames(r),
    row_names_side = NULL, 
    show_row_names = F,
    row_names_gp = gpar(fontsize = 15),
    column_order = colnames(r),
    column_names_side = "top", 
    heatmap_legend_param= list(legend_height = unit(4, "cm"),
                               grid_width= unit(0.5, "cm"),
                               labels_gp= gpar(fontsize = 10)),
    width= unit(w, "cm"),
    height= unit(h, "cm"),
    column_names_gp = gpar(
      fontsize = 15
    ),
    top_annotation= col_anno,
    left_annotation = row_anno,
    # row_split = rep(c('Proliferation', 'Angiogenesis', 'Cell Adhesion'), times=c(3,20,3)),
    row_split = rep(c('Inhibitory', 'Ligand', 'Stimulatory'), times=c(8,15,11)),
    #rowAnnotation = row_anno,
    #heatmap_width = unit(100, "mm"),
    #width = unit(6, "cm"),# 设置热图区域宽度
    #heatmap_height = unit(100, "mm"),
    #height = unit(50, "mm"),
    cell_fun = function(j, i, x, y, width, height, fill) {
      if (p[i,j] < 0.001) {
        grid.text("***",  x, y, gp = gpar(fontsize = 15))
      } else if (p[i,j]<0.01) {
        grid.text("**", x, y, gp = gpar(fontsize = 15))
      } else if (p[i,j]<0.05) {
        grid.text("*",  x, y, gp = gpar(fontsize = 15))
      }else {
        grid.text("", x, y)
      }
    }
  )
}

plot<-function(gene,w,h){
  Costi <- lapply(test, function(x) {
    x <- x[,colnames(x)%in%c(gene,"UPR_score")]
    x<-t(scale(t(x)))
    return(x)
  })
  
  ##批量相关性分析
  ##共刺激因子
  Costi_cor<-lapply(Costi, function(x){
    batch_cor(gene = 'UPR_score',exprSet = t(x))
  })
  Costi_cor<-lapply(Costi_cor,function(x){
    rownames(x)<-x$mRNAs
    x<-x[gene,]
    return(x)
  })
  #Costi_cor
  Costi_cor<-do.call(cbind,Costi_cor)
  
  r1 <- do.call(cbind,Costi_cor)
  selected_cols <- colnames(r1)[grepl("cor|value", colnames(r1))]
  r1<-r1[,selected_cols]
  colnames(r1)
  p1<-r1[,c(2,4,6,8,10)]
  r1<-r1[,c(1,3,5,7,9)]
  #r1<-as.data.frame(r1)
  r1##相关系数矩阵
  r1<-apply(r1, 2,as.numeric)
  rownames(r1)<-gene
  p1
  colnames(r1)<-c('GSE12276','GSE1456','GSE58112','GSE9893','TCGA BRCA')
  colnames(p1)<-c('GSE12276','GSE1456','GSE58112','GSE9893','TCGA BRCA')
  p<-cor_heatmap(r=r1,p=p1,w=w,h=h)
  return(p)
}

plot(gene = gene, w=6 ,h = 12) 
```

