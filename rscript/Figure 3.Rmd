---
title: "Figure 3"
author: "Xinyu Yang"
date: "2026-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(Seurat)
sce <- readRDS('./sce_after_aucell.rds')
sce$celltype[sce$celltype == "Marcrophages"] <- "Myeloids"
df <- data.frame(
  UMAP_1 = sce@reductions$umap@cell.embeddings[, 1],
  UMAP_2 = sce@reductions$umap@cell.embeddings[, 2],
  AUC = sce@meta.data$AUC,
  celltype = sce$celltype
)

# 计算细胞类型中心位置
celltype_centers <- df %>%
  group_by(celltype) %>%
  summarise(
    UMAP_1 = median(UMAP_1),
    UMAP_2 = median(UMAP_2)
  )

# 确定坐标轴的位置
x_start <- min(df$UMAP_1) - 0.5
x_end <- min(df$UMAP_1) + 3
y_start <- min(df$UMAP_2) - 0.5
y_end <- min(df$UMAP_2) + 3

ggplot(df, aes(x = UMAP_1, y = UMAP_2, color = AUC)) +

  geom_point(size = 0.5, alpha = 0.8) +

  geom_text(
    data = celltype_centers,
    aes(label = celltype),
    color = "black",
    size = 2.8,   # ≈ 8 pt
    check_overlap = TRUE
  ) +

  geom_segment(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_start),
    linewidth = 0.6,
    arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
    color = "black"
  ) +

  geom_segment(
    aes(x = x_start, y = y_start, xend = x_start, yend = y_end),
    linewidth = 0.6,
    arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
    color = "black"
  ) +

  annotate(
    "text",
    x = x_start + 3,
    y = y_start - 1.6,
    label = "UMAP_1",
    size = 2.8,
    color = "black"
  ) +

  annotate(
    "text",
    x = x_start - 1.6,
    y = y_start + 3,
    label = "UMAP_2",
    size = 2.8,
    color = "black",
    angle = 90
  ) +

  scale_color_gradientn(
    colours = brewer.pal(9, "YlOrRd"),
    name = "UPR score"
  ) +

  theme_void(base_size = 8) +

  theme(
    legend.position = "right",
    legend.title = element_text(size = 8),
    legend.text  = element_text(size = 7.5),
    plot.title   = element_text(size = 9, hjust = 0.5),
    plot.margin  = margin(8, 8, 8, 8)
  )

# ggsave('./umap_all.pdf',height = 6, width = 9, units = "cm")

# 按平均AUC排序（从高到低）
mean_auc <- df %>%
  group_by(celltype) %>%
  summarise(mean_AUC = mean(AUC, na.rm = TRUE)) %>%
  arrange(desc(mean_AUC))

df$celltype <- factor(df$celltype, levels = rev(mean_auc$celltype))

# 获取细胞类型数量
n_types <- length(levels(df$celltype))

# 方案A：使用Set3配色（最多12种颜色）
if (n_types <= 12) {
  cell_colors <- brewer.pal(n_types, "Set3")
} else {
  # 如果超过12种，使用Set3扩展
  cell_colors <- colorRampPalette(brewer.pal(12, "Set3"))(n_types)
}

# 简洁风格，更接近你提供的代码风格
ggplot(df, aes(x = AUC, y = celltype)) +
  geom_violin(aes(fill = celltype), 
              alpha = 0.7, 
              trim = TRUE, 
              scale = "area",
              width = 0.8) +
  geom_boxplot(width = 0.15, 
               outlier.shape = NA,
               alpha = 0.8) +
  scale_fill_manual(
    values = setNames(cell_colors, levels(df$celltype)),
    name = "Cell Type"
  ) +
  scale_y_discrete(limits = rev(levels(df$celltype))) +
  theme_classic() +
  labs(
    x = "UPR Score",
    y = "Cell Type",
    title = "UPR Score Distribution Across Cell Types"
  ) +
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),  # x轴文本倾斜45°
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    plot.title = element_text(size = 14, hjust = 0.5)
  ) +
  coord_flip()  # 坐标轴翻转

library(viridis)
# 筛选Fibroblast细胞
sce_fibro <- subset(sce, subset = celltype == "Fibroblasts")

pal <- viridis(n = 10, option = "C")
# "#0D0887FF" "#47039FFF" "#7301A8FF" "#9C179EFF" "#BD3786FF" "#D8576BFF" "#ED7953FF" "#FA9E3BFF" "#FDC926FF" "#F0F921FF"
pal <- viridis(n = 15, option = "D", direction = -1)

#使用Seurat::FeaturePlot()做一个常规的可视化
FeaturePlot(object = sce_fibro,features = c("MT1A","MYH11","DCN","APOD"), cols = pal, order = T)
cluster_6_cells <- which(sce_fibro$RNA_snn_res.0.1 == 6)
sce_fibro$celltype[cluster_6_cells] <- "Myfibroblast"

df <- data.frame(
  UMAP_1 = sce_fibro@reductions$umap@cell.embeddings[, 1],
  UMAP_2 = sce_fibro@reductions$umap@cell.embeddings[, 2],
  AUC = sce_fibro@meta.data$AUC,
  celltype = sce_fibro$celltype
)

# 计算细胞类型中心位置
celltype_centers <- df %>%
  group_by(celltype) %>%
  summarise(
    UMAP_1 = median(UMAP_1),
    UMAP_2 = median(UMAP_2)
  )

# 确定坐标轴的位置
x_start <- min(df$UMAP_1) - 0.5
x_end <- min(df$UMAP_1) + 3
y_start <- min(df$UMAP_2) - 0.5
y_end <- min(df$UMAP_2) + 3

# 绘制UMAP图
ggplot(df, aes(x = UMAP_1, y = UMAP_2, color = AUC)) +

  # 背景点
  geom_point(size = 0.5, alpha = 0.8) +

  # 细胞类型标注（≈ 8pt）
  geom_text(
    data = celltype_centers,
    aes(label = celltype),
    color = "black",
    size = 2.8,   # ≈ 8 pt
    check_overlap = TRUE
  ) +

  # UMAP_1 轴箭头
  geom_segment(
    aes(x = x_start, y = y_start, xend = x_end, yend = y_start),
    color = "black",
    linewidth = 0.6,
    arrow = arrow(length = unit(0.25, "cm"), type = "closed")
  ) +

  # UMAP_2 轴箭头
  geom_segment(
    aes(x = x_start, y = y_start, xend = x_start, yend = y_end),
    color = "black",
    linewidth = 0.6,
    arrow = arrow(length = unit(0.25, "cm"), type = "closed")
  ) +

  # 坐标轴文字（≈ 8pt）
  annotate(
    "text",
    x = x_start + 1.5,
    y = y_start - 0.8,
    label = "UMAP_1",
    size = 2.8,
    color = "black"
  ) +

  annotate(
    "text",
    x = x_start - 0.8,
    y = y_start + 1.5,
    label = "UMAP_2",
    size = 2.8,
    color = "black",
    angle = 90
  ) +

  # 颜色标尺
  scale_color_gradientn(
    colours = brewer.pal(9, "YlOrRd"),
    name = "UPR score",
    limits = c(min(df$AUC), max(df$AUC))
  ) +

  theme_void(base_size = 8) +

  theme(
    legend.position = "right",
    legend.title = element_text(size = 8),
    legend.text  = element_text(size = 7.5),
    plot.title   = element_text(size = 9, hjust = 0.5),
    plot.margin  = margin(8, 8, 8, 8)
  )

# ggsave('./umap_fib.pdf',height = 4, width = 6, units = "cm")

df <- data.frame(
  UMAP_1 = sce_fibro@reductions$umap@cell.embeddings[, 1],
  UMAP_2 = sce_fibro@reductions$umap@cell.embeddings[, 2],
  AUC = sce_fibro@meta.data$AUC,
  celltype = sce_fibro@meta.data$celltype
)

library(ggpubr)
# 基础小提琴图
p <- ggviolin(df, x = "celltype", y = "AUC",
              fill = "celltype", 
              palette = c("#1F78B4","#E31A1C"),
              add = "boxplot", 
              legend = "right",
              add.params = list(fill = "white")) +
  stat_compare_means(method = "t.test", 
                     label = "p.signif",
                     label.x = 1.5) +
  labs(
       x = "Group", y = "UPR Score") +
  theme(plot.title = element_text(hjust = 0.5))
colnames(sce_fibro@meta.data)
p
```

```{r}
library(clusterProfiler)
library(GSVA)
library(enrichplot)

##热图绘制
# color
library(ggsci)
library(circlize)
library(RColorBrewer)
library(ComplexHeatmap)
all <- readRDS('./Pan-cancer_UPR_sc.rds')
all1<-t(scale(all))

col_fun = colorRamp2(c(-1, 0, 1), c("#0099CC", "white", "#CC0033"))

# top annotation
# table(metadata$seurat_clusters)
# #   0   1   2   3   4   5   6   7   8
# 711 480 472 344 279 162 144  32  14
library(RColorBrewer)
# anno_col <- pal_npg()(9)
colnames(all1)<-c("Malignant","Stromal","Immune")
colnames(all1)
anno_col <- brewer.pal(3, 'Set2')
names(anno_col) <- colnames(all1)
anno_col

# make annotation
# all1<-all1[,c(3,1,2)],

column_ha = HeatmapAnnotation(celltype = colnames(all1),
                              col = list(celltype = anno_col),
                              border = T)
# all1<-as.data.frame(all1)
Heatmap(all1,
        name = "Z-score",
        cluster_columns = T,cluster_rows = F,
        row_title = "UPR scores",
        # column_title = "Clusters",
        row_names_gp = gpar(fontface = 'italic',fontsize = 10),
        border = T,
        show_column_names = F,
        rect_gp = gpar(col = "white", lwd = 1),
        top_annotation = column_ha,
        column_split = factor(c("Malignant","Stromal","Immune"), 
                              levels = c("Malignant","Stromal","Immune")),
        column_title_rot = 45,
        col = col_fun,
        height =unit(9, "cm"),
        width = unit(4.5, "cm"),
        column_order=c(1,2,3),
        show_column_dend = F,
        cell_fun = function(j, i, x, y, width, height, fill) {
          grid.text(sprintf("%.1f", all1[i, j]), x, y, gp = gpar(fontsize = 14))
        }
)



gsea_res <- readRDS('./gsea_res.rds')
selected_pathways <- gsea_res@result$Description[c(1:10)]
dotplot(gsea_res, showCategory = selected_pathways, font.size = 12) +
  aes(fill = -log10(p.adjust), size = NES) +
  scale_fill_gradient(low = "blue", high = "red", name = "-log10(p.adjust)") +
  scale_size_continuous(name = "NES") +
  ggtitle("Pathways enrichment analysis") +
  guides(fill = guide_colorbar(order = 1), size = guide_legend(order = 2))

sce <- readRDS('./sce_after_aucell.rds')
expr<-read.table('./GSE176078_Wu_etal_2021_bulkRNAseq_raw_counts.txt',sep='\t',skip = 1,row.names = 1)
geneset<-read.gmt('./UPR_WGCNA.gmt')
header<-c('CID3586','CID3921','CID3941','CID3948','CID3963','CID4066','CID4067',
'CID4290A','CID4398','CID44041','CID4461','CID4463','CID4465','CID4471',
'CID4495','CID44971','CID4513','CID4515','CID4523','CID4530N','CID4535','CID4040',
'CID3838','CID3946')
colnames(expr)<-header
expr<-log2(expr+0.1)
genesets4gsva<-split(geneset$gene,geneset$term)
exp_geneset<-gsva(expr = as.matrix(expr),#这里必须输入matrix而不能是dataframe
                  gset.idx.list = genesets4gsva,
                  method='ssgsea',
                  kcdf='Gaussian')#log后的TPM用高斯分布
exp_geneset<-as.data.frame(t(exp_geneset))
exp_geneset$group<-ifelse(exp_geneset$WGCNA_UPR>3.509266,'high','low')

do.tissueDist <- function(cellInfo.tb = cellInfo.tb,
                          meta.cluster = cellInfo.tb$meta.cluster,
                          colname.patient = "patient",
                          loc = cellInfo.tb$loc,
                          out.prefix,
                          pdf.width=3,
                          pdf.height=5,
                          verbose=0,z.hi.OR=4,z.hi.ROE=2){
  ##input data
  # 
  library("Startrac")
  library(data.table)
  dir.create(dirname(out.prefix),F,T)
  
  cellInfo.tb = data.table(cellInfo.tb)
  cellInfo.tb$meta.cluster = as.character(meta.cluster)
  
  if(is.factor(loc)){
    cellInfo.tb$loc = loc
  }else{cellInfo.tb$loc = as.factor(loc)}
  
  loc.avai.vec <- levels(cellInfo.tb[["loc"]])
  count.dist <- unclass(cellInfo.tb[,table(meta.cluster,loc)])[,loc.avai.vec]
  freq.dist <- sweep(count.dist,1,rowSums(count.dist),"/")
  freq.dist.bin <- floor(freq.dist * 100 / 10)
  print(freq.dist.bin)
  
  {
    count.dist.melt.ext.tb <- test.dist.table(count.dist)
    p.dist.tb <- dcast(count.dist.melt.ext.tb,rid~cid,value.var="p.value")
    OR.dist.tb <- dcast(count.dist.melt.ext.tb,rid~cid,value.var="OR")
    OR.dist.mtx <- as.matrix(OR.dist.tb[,-1])
    rownames(OR.dist.mtx) <- OR.dist.tb[[1]]
  }
  
  startrac.dist <- unclass(Startrac::calTissueDist(cellInfo.tb,byPatient = F,
                                                   colname.cluster="meta.cluster",
                                                   colname.patient = "patient",
                                                   colname.tissue = "loc"))
  startrac.dist <- startrac.dist[,loc.avai.vec]
  
  # cuts <- c(0, 0.8, 1.2,Inf)
  # startrac.dist.bin.values <- factor(c("-", "+/-", "+"),levels=c("-", "+/-", "+"))
  # startrac.dist.bin <- matrix(startrac.dist.bin.values[findInterval(startrac.dist, cuts)],
  #                             ncol=ncol(startrac.dist))
  # colnames(startrac.dist.bin) <- colnames(startrac.dist)
  # rownames(startrac.dist.bin) <- rownames(startrac.dist)
  
  #	sscClust:::plot.matrix.simple(freq.dist.bin,
  #								  col.ht=rev(structure(colorRampPalette(brewer.pal(9,name="Blues"))(10),
  #												   names=0:9 )),
  #								  par.legend=list(labels=rev(sprintf("%s%%~%s%%",10*(0:9),c(10*(1:9),100) )),
  #												  at=0:9),
  #								  out.prefix=sprintf("%s.freq.dist",out.prefix),
  #								  show.number=F,clust.row=T,exp.name=expression(italic(Freq)),
  #								  #palatte=(brewer.pal(n = 7,name = "Blues")),
  #								  #palatte=viridis::viridis(7),
  #								  pdf.width = 4.5, pdf.height = pdf.height)
  
  #	sscClust:::plot.matrix.simple(startrac.dist.bin,
  #								  col.ht=rev(structure(viridis::viridis(3),
  #													   names=levels(startrac.dist.bin.values))),
  #								  out.prefix=sprintf("%s.startrac.dist.bin",out.prefix),
  #								  show.number=F,clust.row=T,exp.name=expression(italic(R)[o/e]),
  #								  pdf.width = pdf.width, pdf.height = pdf.height)
  
  sscVis::plotMatrix.simple(startrac.dist,
                            out.prefix=sprintf("%s.startrac.dist",out.prefix),
                            show.number=F,
                            clust.row=T,
                            #waterfall.row=T,par.warterfall = list(score.alpha = 2,do.norm=T),
                            exp.name=expression(italic(R)[o/e]),
                            z.hi=z.hi.ROE,
                            #palatte=rev(brewer.pal(n = 7,name = "RdYlBu")),
                            palatte=viridis::viridis(7),
                            pdf.width = pdf.width, pdf.height = pdf.height)
  
  sscVis::plotMatrix.simple(OR.dist.mtx,
                            out.prefix=sprintf("%s.OR.dist",out.prefix),
                            show.number=F,
                            #clust.row=T,
                            #par.legend=list(color_bar = "discrete",at=seq(0,4,0.5)),
                            waterfall.row=T,par.warterfall = list(score.alpha = 2,do.norm=T),
                            exp.name=expression(italic(OR)),
                            z.hi=z.hi.OR,
                            #palatte=rev(brewer.pal(n = 7,name = "RdYlBu")),
                            palatte=viridis::viridis(7),
                            pdf.width = pdf.width, pdf.height = pdf.height)
  if(verbose==1){
    return(list("count.dist.melt.ext.tb"=count.dist.melt.ext.tb,
                "p.dist.tb"=p.dist.tb,
                "OR.dist.tb"=OR.dist.tb,
                "OR.dist.mtx"=OR.dist.mtx,
                "startrac.dist.ROE" = startrac.dist))
  }else{
    return(OR.dist.mtx)
  }
  
}

test.dist.table <- function(count.dist,min.rowSum=0)
{
  library(plyr)
  count.dist <- count.dist[rowSums(count.dist)>=min.rowSum,,drop=F]
  sum.col <- colSums(count.dist)
  sum.row <- rowSums(count.dist)
  count.dist.tb <- as.data.frame(count.dist)
  setDT(count.dist.tb,keep.rownames=T)
  count.dist.melt.tb <- melt(count.dist.tb,id.vars="rn")
  colnames(count.dist.melt.tb) <- c("rid","cid","count")
  count.dist.melt.ext.tb <- as.data.table(plyr::ldply(seq_len(nrow(count.dist.melt.tb)), function(i){
    this.row <- count.dist.melt.tb$rid[i]
    this.col <- count.dist.melt.tb$cid[i]
    this.c <- count.dist.melt.tb$count[i]
    other.col.c <- sum.col[this.col]-this.c
    this.m <- matrix(c(this.c,
                       sum.row[this.row]-this.c,
                       other.col.c,
                       sum(sum.col)-sum.row[this.row]-other.col.c),
                     ncol=2)
    res.test <- fisher.test(this.m)
    data.frame(rid=this.row,
               cid=this.col,
               p.value=res.test$p.value,
               OR=res.test$estimate)
  }))
  count.dist.melt.ext.tb <- merge(count.dist.melt.tb,count.dist.melt.ext.tb,
                                  by=c("rid","cid"))
  count.dist.melt.ext.tb = data.table(count.dist.melt.ext.tb)
  count.dist.melt.ext.tb[,adj.p.value:=p.adjust(p.value,"BH")]
  #count.dist.melt.ext.tb[adj.p.value < 0.05,]
  #count.dist.melt.ext.tb[p.value < 0.05 & OR > 0,]
  
  return(count.dist.melt.ext.tb)
  
}

doPlotORHT <- function(OR.all.mtx,out.prefix,note.str="",
                       method.distance="",k=3,
                       do.hclust=T,pdf.width = 5.5, pdf.height = 10)
{
  
  OR.all.mtx.tmp <- OR.all.mtx
  OR.all.mtx.tmp[OR.all.mtx.tmp > 3] <- 3
  
  OR.hclust.row <- NULL
  
  if(do.hclust){
    OR.hclust.row <- run.cutree(OR.all.mtx.tmp,k=k,method.distance=method.distance,method.hclust="ward.D2")
    ##OR.hclust.row <- run.cutreeDynamic(OR.all.mtx,deepSplit=1, minClusterSize=2,method.distance="")
    OR.hclust.row$branch <- dendextend::set(OR.hclust.row$branch,"branches_lwd", 2)
  }else{
    th.OR <- 1.5
    OR.pattern <- OR.all.mtx > th.OR
    colnames(OR.pattern) <- sprintf("bin.%s",colnames(OR.pattern))
    ##OR.ext.tb <- cbind(data.table(cluster.name=rownames(OR.all.mtx)),
    OR.ext.tb <- cbind(data.table(cluster.name=rownames(OR.all.mtx.tmp)),
                       OR.pattern,OR.all.mtx)
    
    OR.tb.list <- list()
    cname.used <- c()
    OR.tb.list[["enrichT"]] <- OR.ext.tb[bin.T==TRUE,][order(-T),]
    cname.used <- c(cname.used,OR.tb.list[["enrichT"]][["cluster.name"]])
    OR.tb.list[["enrichP"]] <- OR.ext.tb[!(cluster.name %in% cname.used) & bin.P==TRUE,][order(-P),]
    cname.used <- c(cname.used,OR.tb.list[["enrichP"]][["cluster.name"]])
    OR.tb.list[["enrichN"]] <- OR.ext.tb[!(cluster.name %in% cname.used) & bin.N==TRUE,][order(-N),]
    cname.used <- c(cname.used,OR.tb.list[["enrichN"]][["cluster.name"]])
    OR.tb.list[["enrichO"]] <- OR.ext.tb[!(cluster.name %in% cname.used),]
    
    OR.tb.order.list <- llply(names(OR.tb.list),function(x){
      #x <- "enrichT"
      x.hclust <- run.cutree(as.matrix(OR.tb.list[[x]][,c("P","N","T")]),
                             k=1,method.distance=method.distance,method.hclust="ward.D2")
      ##OR.tb.list[[x]][rev(x.hclust$hclust$order),]
      OR.tb.list[[x]][(x.hclust$hclust$order),]
      #setorderv()
    })
    names(OR.tb.order.list) <- names(OR.tb.list)
    
    OR.order.mtx <- do.call(rbind,llply(names(OR.tb.order.list),function(x){
      a.mtx <- as.matrix(OR.tb.order.list[[x]][,c("P","N","T")])
      rownames(a.mtx) <- OR.tb.order.list[[x]][["cluster.name"]]
      return(a.mtx)
    }))
    OR.all.mtx <- OR.all.mtx[rownames(OR.order.mtx),]
  }
  
  mapping.col <- g.colSet$meta.cluster
  names(mapping.col) <- mcls2Name[names(mapping.col)]
  #col.row.man <- mapping.col[rownames(OR.all.mtx.tmp)[OR.hclust.row$hclust$order]]
  col.row.man <- mapping.col[rownames(OR.all.mtx)]
  
  sscVis:::plotMatrix.simple(OR.all.mtx,
                             col.ht=circlize::colorRamp2(c(0, 1, 3), viridis::viridis(3)),
                             out.prefix=sprintf("%s.OR.dist.rClust.withDend.a%s",out.prefix,note.str),
                             show.number=F, show.dendrogram=do.hclust,
                             clust.row=if(do.hclust) OR.hclust.row$branch else FALSE,
                             row_dend_width = unit(1.5, "cm"),
                             #par.legend=list(color_bar = "discrete",at=seq(0,4,0.5)),
                             #waterfall.row=T,par.warterfall = list(score.alpha = 2,do.norm=T),
                             exp.name=expression(italic(OR)),
                             z.hi=3,
                             #palatte=rev(brewer.pal(n = 7,name = "RdYlBu")),
                             #palatte=viridis::viridis(7),
                             par.heatmap=list(cex.row=1.5,
                                              row_names_gp=gpar(col=col.row.man,fontsize=10)),
                             pdf.width = pdf.width, pdf.height = pdf.height)
  
  return(OR.hclust.row)
  
}


group_df <- data.frame(
  orig.ident = rownames(exp_geneset),
  group = exp_geneset$group,
  stringsAsFactors = FALSE
)

meta <- sce@meta.data %>% 
  tibble::rownames_to_column("cell")
meta <- meta %>% 
  left_join(group_df, by = "orig.ident")%>%
  mutate(celltype = ifelse(celltype == "Marcrophages", "Myeloid cells", celltype))
sce@meta.data <- meta %>% 
  tibble::column_to_rownames("cell")

meta.tb <- sce@meta.data
out.prefix <- "./"
OR.epi.list <- do.tissueDist(cellInfo.tb=meta.tb,
                             meta.cluster = meta.tb$celltype,
                             colname.patient = "orig.ident",
                             loc = meta.tb$group,
                             out.prefix=paste0(out.prefix,"STARTRAC.dist.Epi_cells"),
                             pdf.width=5, pdf.height=6,verbose=1,
                             z.hi.OR = 4,
                             z.hi.ROE = 2)
knitr::include_graphics("./STARTRAC.dist.Epi_cells.OR.dist.pdf")
```



```{r}
##percent_upr 
library(dplyr)
library(ggplot2)
library(ggpubr)

load('./sce_hl_BRCA.RData')

UPR_H<-c("CID3921","CID3963","CID4461","CID4465","CID4495","CID4513",
         "CID4515","CID4523","CID4535","CID4040","CID3838","CID3946")
test<-sce@meta.data[,c(1,17,21)]
test<-data.frame('celltype'=test$celltype,
                 'subtype'=test$group,
                 'patient'=test$orig.ident)

result <- test %>%
  group_by(patient, celltype) %>%               # 按照患者和细胞类型分组
  dplyr::summarise(count = n()) %>%                    # 统计每个组合的计数
  group_by(patient) %>%                          # 按照患者分组
  mutate(percentage = count / sum(count) * 100)  # 计算百分比
length(unique(result$patient))
result$group<-ifelse(result$patient%in%UPR_H,'High','Low')

comparisons<-list(c('High','Low'))
ggplot(filter(result,celltype!='Epithelial cells'),aes(group,percentage,color=group,fill=group))+geom_jitter(width = .15)+
  geom_boxplot(width=.4,alpha=.7)+
  facet_wrap(~celltype,ncol = 8)+theme_test()+
  labs(y='Percentage',x='')+
  stat_compare_means(comparisons = comparisons,method = 'wilcox.test',
                     size=4)+
  scale_y_continuous(expand = c(0.1,0.1))+#将y轴上下拉宽一些，这样被遮住的p值就可以完整显示
  theme(axis.text = element_text(color = 'black',size = 10),
        axis.line = element_blank())+
  scale_color_manual(values = c("#E31A1C","#1F78B4"))+
  scale_fill_manual(values = c("#E31A1C","#1F78B4"))+
  theme(strip.background = element_blank(),
        strip.text = element_text(size=12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 12))
```

