---
title: "Figure 2"
author: "Xinyu Yang"
date: "2025-12-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r,fig.width=10, fig.height=15}
library(ComplexHeatmap)
library(RColorBrewer)
library(circlize)
load('./color_for_scRNAseq.Rdata')
df_non <- readRDS('./df_non.rds')

df<-data.frame(colnames(df_non))
colnames(df)<-'Type'
cols <- data.color$color.scRNAseq[1:10]
names(cols) <- df$Type

top_anno<-HeatmapAnnotation(df=df,
                            show_annotation_name = F,
                            gp = gpar(col = 'white', lwd = 2),
                            col=list(Type=cols))

mycolor2<-colorRamp2(c(-0.3, 0, 0.3), c("#0da9ce", "white", "#e74a32"))
Heatmap(df_non,
        cluster_columns = F,
        cluster_rows = T,
        show_row_dend = F,
        name='Corelation',
        # col = colorRampPalette(rev(brewer.pal(11,'RdYlBu')))(32))
        col=mycolor2,
        top_annotation = top_anno,
        column_names_rot = 45,
        row_names_gp = gpar(fontface = 'italic',fontsize = 10),
        width= unit(10, "cm"),
        height= unit(15, "cm"),
        column_names_side = c('top'),
        rect_gp = gpar(col = "white", lwd = 1))

```

```{r}
CD274 <- readRDS('./CD274.rds')
library(cols4all)
library(ggplot2)
ggplot(CD274,aes(x = `log2FoldChange`,y = tumor)) +
  geom_col(aes(fill = -log10(pvalue)), width = 0.1) +
  geom_point(aes(size =log2FoldChange ,
                 color = -log10(pvalue))) +
  scale_size_continuous(range = c(2, 7)) +
  scale_color_continuous_c4a_div('sunset', mid = 0) +
  scale_fill_continuous_c4a_div('sunset', mid = 0) +
  theme_classic()+
  ylab('') +
  theme(
    axis.text = element_text(size = 12), #轴标签大小调整
    axis.title.x = element_text(size = 14), #x轴标题大小调整
    legend.title = element_text(size = 14), #图例标题大小调整
    legend.text = element_text(size = 12) ,#图例标签大小调整
    plot.title = element_text(size = 14,hjust = 0.5) ##标题的大小
  )+
  ggtitle('CD274 Expression')


```

```{r}
library(ComplexHeatmap)
library(RColorBrewer)
library(ComplexHeatmap)
library(circlize)

cor_all <- readRDS('./cibersort_results_cor_all.rds')
load('./color_for_scRNAseq.Rdata')

cor_all_scale<-scale(cor_all)
rownames(cor_all_scale)<-gsub("_CIBERSORT", "", rownames(cor_all_scale))

df<-data.frame(colnames(cor_all_scale))
colnames(df)<-'Type'
cols <- data.color$color.scRNAseq[1:10]
names(cols) <- df$Type
top_anno<-HeatmapAnnotation(df=df,
                            show_annotation_name = F,
                            gp = gpar(col = 'white', lwd = 2),
                            col=list(Type=cols))

mycolor2<-mycol2 <- colorRamp2(c(-2, 0, 2), c("#0da9ce", "white", "#e74a32"))
Heatmap(cor_all_scale,
        cluster_columns = F,
        cluster_rows = T,
        show_row_dend = FALSE,
        name='Corelation',
        # col = colorRampPalette(rev(brewer.pal(11,'RdYlBu')))(32))
        col=mycolor2,
        top_annotation = top_anno,
        column_names_rot = 60,
        column_names_side = c('top'),
        row_names_gp = gpar(fontsize = 12, fontface = 'italic'),
        rect_gp = gpar(col = "white", lwd = 1.5))


```



```{r}
library(ggplot2)
enrich <- readRDS('./enrich.rds')

if(T){
  text.size = 10
  text.angle = 45
  text.hjust = 1
  legend.position = "right"
  mytheme <- theme(plot.title = element_text(size = text.size+2,color="black",hjust = 0.5),
                   axis.ticks = element_line(color = "black"),
                   axis.title = element_text(size = text.size,color ="black"), 
                   axis.text = element_text(size=text.size,color = "black"),
                   axis.text.x = element_text(angle = text.angle, hjust = text.hjust ), #,vjust = 0.5
                   #axis.line = element_line(color = "black"),
                   #axis.ticks = element_line(color = "black"),
                   #panel.grid.minor.y = element_blank(),
                   #panel.grid.minor.x = element_blank(),
                   panel.grid=element_blank(), # 去网格线
                   legend.position = legend.position,
                   legend.text = element_text(size= text.size),
                   legend.title= element_text(size= text.size),
                   # panel.border = element_rect(fill=NA,color="black", size=0.8, linetype="solid"),
                   # strip.background = element_rect(color="black",size= 1, linetype="solid") # fill="#FC4E07", 
  )
}

ggplot(enrich, aes(x=tumor,y=ID)) +
  geom_point(shape=21,aes(size=-log10(pvalue),fill=NES,color=group),position =position_dodge(0)) +
  labs(title = "Pathway enrichment analysis",y=NULL,x=NULL) + 
  scale_color_manual(values = c('white','black'))+
  scale_fill_gradient2(
    low = "#0072B5FF",
    mid = "white",
    high = "#FF7F00",
    midpoint = 0
  )+
  theme_bw() + mytheme +
  theme(legend.key.size = unit(0.4, "cm"),axis.text.x=element_text(angle=45, hjust=1)) + 
  scale_size(name = "-log10 (pvalue)",range = c(1,4.2))

```

```{r}

```


```{r}
library(ggplot2)
library(ggpubr)
all_score_list <- readRDS('./stemscore_33tumors.rds')

a<-list()
for (i in names(all_score_list)) {
  x<-all_score_list[[i]]
  x$Type<-i
  a[[i]]<-x
}
a<-do.call(rbind,a)
need<-c('BLCA','KIRP','COAD','KIRC','THCA','BRCA','HNSC','PRAD','LUAD','KICH')
A<-dplyr::filter(a,a$Type%in%need)
colnames(A)[3]<-'Group'
p<-ggplot(A, aes(x = Group, y = stemness_score, fill = Group, color = Group)) +
  #geom_line(aes(group = paired), color = "grey80", size = 0.5) +
  geom_point(size = 1, position = position_jitter(w = 0.1)) +
  stat_compare_means(comparisons = list(c("High", "Low")), 
                     paired = F, size = 2,label = "p.signif",tip.length = 0.05) +
  facet_wrap(~ Type, scales = 'free_y', nrow = 2) +
  scale_color_manual(values = c('#F3993A','#84AED0')) +
  theme_classic2(base_size = 12)+ 
  scale_y_continuous(expand = c(0.1,0.1))

p
```


```{r}
library(ggplot2)
library(ggpubr)
BRCA<-as.data.frame(all_score_list$BRCA)
p1<-ggplot(BRCA,aes_string(x = 'UPR_score',y = 'stemness_score')) +
  geom_point(size = 2,color = '#eebabb',alpha = 0.5) +
  theme_bw() +
  # 主题细节调整
  theme(axis.title = element_text(size = 16),
        axis.text = element_text(size = 14),
        axis.ticks.length = unit(0.25,'cm'),
        axis.ticks = element_line(size = 1),
        panel.border = element_rect(size = 1.5),
        panel.grid = element_blank(),
        plot.title = element_text(size = 18,hjust=0.5)
  ) +
  # 添加回归线
  geom_smooth(method = 'lm',se = T,color = '#d86967',size = 1.5,fill = '#d86967') +
  # 添加相关性系数及p值
  stat_cor(method = "pearson",digits = 3,size=6)+
  labs(
    title = "BRCA",  # 设置标题
    x = "UPR Score",
    y = "Stemness Score"
  )
p1

KIRP<-as.data.frame(all_score_list$KIRP)
p2<-ggplot(KIRP,aes_string(x = 'UPR_score',y = 'stemness_score')) +
  geom_point(size = 2,color = '#eebabb',alpha = 0.5) +
  theme_bw() +
  # 主题细节调整
  theme(axis.title = element_text(size = 16),
        axis.text = element_text(size = 14),
        axis.ticks.length = unit(0.25,'cm'),
        axis.ticks = element_line(size = 1),
        panel.border = element_rect(size = 1.5),
        panel.grid = element_blank(),
        plot.title = element_text(size = 18,hjust=0.5)
  ) +
  # 添加回归线
  geom_smooth(method = 'lm',se = T,color = '#d86967',size = 1.5,fill = '#d86967') +
  # 添加相关性系数及p值
  stat_cor(method = "pearson",digits = 3,size=6)+
  labs(
    title = "KIRP",  # 设置标题
    x = "UPR Score",
    y = "Stemness Score"
  )
p2
```

